<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GST Invoice Maker (India) — Free, Printable, No Sign-up</title>
<meta name="description" content="Create Indian GST invoices with CGST/SGST/IGST, HSN/SAC, discounts, cess, round-off, HSN-wise tax summary. Print or save to PDF. 100% free, works offline.">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Martel:wght@700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0e0f13; --card:#10141f; --ink:#e8ecf1; --muted:#9aa5b1; --accent:#66e3ff;
  --line:#1e2333; --ok:#18c08f; --warn:#ffbf47; --bad:#ff5d7a;
  --paper:#ffffff; --ink-print:#000000; --line-print:#cccccc;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg,#0b0c10,#101528);
  color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
.container{max-width:1120px; margin:auto; padding:18px}
h1{font-family:Martel,Georgia,serif; margin:.2em 0 .6em}
.card{background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:14px}
.row{display:flex; gap:12px; flex-wrap:wrap}
.col{flex:1 1 260px; min-width:260px}
label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px}
input,select,textarea{
  width:100%; background:#0f1424; color:var(--ink);
  border:1px solid #22283a; border-radius:10px; padding:8px 10px; font-weight:600; outline:none;
}
input::placeholder,textarea::placeholder{color:#7f8899}
textarea{min-height:70px; resize:vertical}
button{appearance:none; border:1px solid #2a324a; background:#131a2f; color:var(--ink); border-radius:10px; padding:9px 12px; font-weight:700; cursor:pointer}
button.primary{background:var(--accent); color:#09101f; border-color:transparent}
button.ghost{background:transparent}
button.warn{background:#221a06; border-color:#5a4210; color:#ffd56b}
.kbd{font-family:ui-monospace,Consolas,Menlo,monospace; font-size:12px; border:1px solid #2a324a; background:#0d1223; padding:0 6px; border-radius:6px}
hr.sep{border:0; border-top:1px dashed #2a324a; margin:10px 0}
.small{font-size:12px; color:var(--muted)}
.flex{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.right{margin-left:auto}
.badge{font-size:12px; border:1px solid #2a324a; border-radius:999px; padding:3px 8px; color:#a9b2c7}

/* Items table */
.table{width:100%; border-collapse:collapse; font-size:14px}
.table th, .table td{border-bottom:1px solid #1e2333; padding:8px; vertical-align:middle}
.table th{color:#b8c0d6; font-weight:700; text-align:left; position:sticky; top:0; background:rgba(16,20,31,.9); backdrop-filter:blur(4px)}
.table tfoot td{font-weight:700}
input.cell{width:100%; padding:6px 8px; font-size:14px; background:#0f1424; border:1px solid #22283a; border-radius:8px}
select.cell{width:100%; padding:6px 8px; font-size:14px; background:#0f1424; border:1px solid #22283a; border-radius:8px}
.table .num{text-align:right}
.actions{display:flex; gap:8px; flex-wrap:wrap}

/* Invoice preview (print layout) */
#printArea{background:#0a0d18; padding:8px}
.paper{width:210mm; min-height:297mm; margin:auto; background:var(--paper); color:var(--ink-print); border:1px solid #2a324a; border-radius:4px; padding:18mm 16mm}
.headline{display:flex; gap:14px; align-items:center}
.logo{width:70px; height:70px; background:#e9eef5; border:1px solid #d9dfe9; display:flex; align-items:center; justify-content:center; font-weight:800; border-radius:8px; overflow:hidden}
.logo img{width:100%; height:100%; object-fit:cover}
.title-block{flex:1}
.paper h2{margin:0 0 6px 0; font-family:Martel,Georgia,serif}
.grid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
.box{border:1px solid var(--line-print); border-radius:6px; padding:8px}
.paper table{width:100%; border-collapse:collapse; font-size:12.5px}
.paper th,.paper td{border:1px solid var(--line-print); padding:6px}
.paper th{background:#f6f7fb; text-align:left}
.tright{text-align:right}
.tcenter{text-align:center}
.note{font-size:11.5px}
.signature{height:64px; width:220px; border:1px dashed #bbb; display:flex; align-items:center; justify-content:center}

/* Print */
@media print{
  body{background:white}
  .container{display:none}
  #printArea{padding:0}
  .paper{border:0}
}
</style>
</head>
<body>
<div class="container">
  <h1>GST Invoice Maker (India)</h1>
  <div class="card">
    <div class="flex">
      <div class="badge">Works offline</div>
      <div class="badge">A4 print / PDF</div>
      <div class="badge">HSN Summary</div>
      <span class="small right">Tip: Press <span class="kbd">Ctrl/Cmd + P</span> to save as PDF after you’re done.</span>
    </div>
  </div>

  <!-- Parties -->
  <div class="card">
    <div class="row">
      <div class="col">
        <h3>Seller (Your Business)</h3>
        <label>Legal Name</label><input id="s_name" placeholder="ABC Traders Pvt Ltd">
        <label>GSTIN</label><input id="s_gstin" placeholder="27XXXXXXXXX1Z5" maxlength="15">
        <label>Address</label><textarea id="s_addr" placeholder="Street, Area, City, PIN"></textarea>
        <div class="row">
          <div class="col"><label>State</label><input id="s_state" placeholder="Maharashtra"></div>
          <div class="col"><label>State Code</label><input id="s_statecode" placeholder="27"></div>
        </div>
        <label>PAN (optional)</label><input id="s_pan" placeholder="ABCDE1234F" maxlength="10">
        <label>Bank / UPI Details (prints in note)</label><textarea id="s_bank" placeholder="Bank: …, A/c: …, IFSC: …, UPI: …@…"></textarea>
        <label>Logo</label><input id="s_logo" type="file" accept="image/*">
      </div>
      <div class="col">
        <h3>Buyer</h3>
        <label>Legal Name</label><input id="b_name" placeholder="XYZ Retail LLP">
        <label>GSTIN (optional for B2C)</label><input id="b_gstin" placeholder="29XXXXXXXXX1Z6" maxlength="15">
        <label>Billing Address</label><textarea id="b_addr" placeholder="Street, Area, City, PIN"></textarea>
        <div class="row">
          <div class="col"><label>State</label><input id="b_state" placeholder="Karnataka"></div>
          <div class="col"><label>State Code</label><input id="b_statecode" placeholder="29"></div>
        </div>
        <div class="row">
          <div class="col"><label>Place of Supply (State)</label><input id="pos_state" placeholder="Karnataka"></div>
          <div class="col"><label>POS Code</label><input id="pos_code" placeholder="29"></div>
        </div>
        <label>E-commerce Operator (optional)</label><input id="ecom" placeholder="e.g., Amazon, Flipkart">
      </div>
      <div class="col">
        <h3>Invoice</h3>
        <div class="row">
          <div class="col"><label>Prefix</label><input id="inv_prefix" placeholder="FY25-26/"></div>
          <div class="col"><label>Number</label><input id="inv_number" placeholder="0001"></div>
        </div>
        <div class="row">
          <div class="col"><label>Date</label><input id="inv_date" type="date"></div>
          <div class="col"><label>Due Date</label><input id="inv_due" type="date"></div>
        </div>
        <div class="row">
          <div class="col"><label>Reverse Charge</label>
            <select id="reverse_charge" class="cell">
              <option value="No" selected>No</option><option>Yes</option>
            </select>
          </div>
          <div class="col">
            <label>Tax Nature</label>
            <select id="tax_mode" class="cell" title="Auto chooses IGST for inter-state; CGST/SGST for intra-state">
              <option value="auto" selected>Auto (by State)</option>
              <option value="igst">Force IGST</option>
              <option value="cgst_sgst">Force CGST+SGST</option>
              <option value="zero">Zero-rated/Exempt</option>
            </select>
          </div>
        </div>
        <label>Transport (optional)</label>
        <div class="row">
          <div class="col"><input id="trans_mode" placeholder="Mode (By Road/Air/etc.)"></div>
          <div class="col"><input id="veh_no" placeholder="Vehicle No."></div>
        </div>
        <div class="row">
          <div class="col"><input id="place_supply" placeholder="Place of Supply (City)"></div>
          <div class="col"><input id="lr_no" placeholder="LR/GR No."></div>
        </div>
        <label>Signature</label><input id="s_sign" type="file" accept="image/*">
      </div>
    </div>
  </div>

  <!-- Items -->
  <div class="card">
    <div class="flex">
      <h3 style="margin:0">Items</h3>
      <div class="right actions">
        <button class="primary" id="addItem">+ Add Row</button>
        <button class="ghost" id="clearItems">Clear Items</button>
      </div>
    </div>
    <div style="max-height:320px; overflow:auto; border:1px solid #1e2333; border-radius:10px; margin-top:8px">
      <table class="table" id="itemsTbl">
        <thead>
          <tr>
            <th style="width:20px">#</th>
            <th>Description</th>
            <th>HSN/SAC</th>
            <th class="tcenter">Qty</th>
            <th>Unit</th>
            <th class="tright">Rate</th>
            <th class="tright">Disc %</th>
            <th class="tcenter">GST %</th>
            <th class="tcenter">Cess %</th>
            <th class="tright">Taxable</th>
            <th class="tright">Actions</th>
          </tr>
        </thead>
        <tbody id="itemsBody"></tbody>
      </table>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="col">
        <label>Additional Taxable Charge (e.g., Freight)</label>
        <div class="row">
          <div class="col"><input id="add_desc" placeholder="Freight/Packaging"></div>
          <div class="col"><input id="add_amount" type="number" step="0.01" placeholder="Amount"></div>
          <div class="col">
            <select id="add_gst" class="cell">
              <option value="0">GST 0%</option>
              <option>5</option><option selected>12</option><option>18</option><option>28</option>
            </select>
          </div>
          <div class="col"><input id="add_hsn" placeholder="HSN/SAC"></div>
        </div>
      </div>
      <div class="col">
        <label>Post-tax Charges/Discount (₹)</label>
        <input id="post_tax" type="number" step="0.01" placeholder="Positive = charge, Negative = discount">
      </div>
      <div class="col">
        <label>Notes / Terms (prints)</label>
        <textarea id="terms" placeholder="Goods once sold will not be taken back. Subject to [City] jurisdiction."></textarea>
      </div>
    </div>
  </div>

  <!-- Actions -->
  <div class="card">
    <div class="flex">
      <div class="actions">
        <button id="recalc">Recalculate</button>
        <button class="primary" id="printBtn">Print / Save PDF</button>
      </div>
      <div class="actions right">
        <button id="saveDraft">Save (local)</button>
        <button id="loadDraft">Load</button>
        <button id="exportJson">Export JSON</button>
        <button class="warn" id="importJson">Import JSON</button>
        <button class="ghost" id="newNumber">Next Invoice Number</button>
      </div>
    </div>
  </div>

  <!-- Preview -->
  <div id="printArea">
    <div class="paper" id="paper">
      <div class="headline">
        <div class="logo" id="logoBox"><span>LOGO</span></div>
        <div class="title-block">
          <h2 style="margin-bottom:2px">Tax Invoice</h2>
          <div style="font-size:12.5px">Original for Recipient</div>
        </div>
        <div class="tright" style="margin-left:auto">
          <div><strong>Invoice No:</strong> <span id="pv_invno"></span></div>
          <div><strong>Date:</strong> <span id="pv_invdate"></span></div>
          <div><strong>Due:</strong> <span id="pv_due"></span></div>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="box">
          <strong>Supplier</strong><br>
          <div id="pv_sname"></div>
          <div class="note" id="pv_saddr"></div>
          <div>GSTIN: <span id="pv_sgstin"></span> &nbsp; <span class="note">State: <span id="pv_sstate"></span> (<span id="pv_scode"></span>)</span></div>
          <div class="note">PAN: <span id="pv_span"></span></div>
        </div>
        <div class="box">
          <strong>Recipient</strong><br>
          <div id="pv_bname"></div>
          <div class="note" id="pv_baddr"></div>
          <div>GSTIN: <span id="pv_bgstin"></span> &nbsp; <span class="note">State: <span id="pv_bstate"></span> (<span id="pv_bcode"></span>)</span></div>
          <div class="note">Place of Supply: <span id="pv_pos"></span> (<span id="pv_poscode"></span>)</div>
          <div class="note">E-com: <span id="pv_ecom"></span></div>
        </div>
      </div>

      <table style="margin-top:10px">
        <thead>
          <tr>
            <th style="width:24px">#</th>
            <th>Description</th>
            <th>HSN/SAC</th>
            <th class="tcenter">Qty</th>
            <th class="tcenter">Unit</th>
            <th class="tright">Rate</th>
            <th class="tright">Disc</th>
            <th class="tcenter">GST %</th>
            <th class="tcenter">Cess %</th>
            <th class="tright">Taxable (₹)</th>
          </tr>
        </thead>
        <tbody id="pv_items"></tbody>
      </table>

      <div class="grid" style="margin-top:10px">
        <div class="box">
          <div><strong>Tax Details</strong></div>
          <table style="margin-top:6px">
            <thead><tr><th>Tax</th><th class="tright">Amount (₹)</th></tr></thead>
            <tbody>
              <tr><td>CGST</td><td class="tright" id="pv_cgst">0.00</td></tr>
              <tr><td>SGST</td><td class="tright" id="pv_sgst">0.00</td></tr>
              <tr><td>IGST</td><td class="tright" id="pv_igst">0.00</td></tr>
              <tr><td>Cess</td><td class="tright" id="pv_cess">0.00</td></tr>
              <tr><td><strong>Taxable Value</strong></td><td class="tright" id="pv_taxable"><strong>0.00</strong></td></tr>
              <tr><td>Pre-tax Add.Charge</td><td class="tright" id="pv_addtaxable">0.00</td></tr>
              <tr><td>Post-tax Adj.</td><td class="tright" id="pv_posttax">0.00</td></tr>
              <tr><td>Round Off</td><td class="tright" id="pv_roundoff">0.00</td></tr>
              <tr><td><strong>Invoice Total</strong></td><td class="tright" id="pv_total"><strong>0.00</strong></td></tr>
            </tbody>
          </table>
          <div class="note" style="margin-top:6px">Amount in words: <em id="pv_words"></em></div>
        </div>
        <div class="box">
          <div><strong>HSN Summary</strong></div>
          <table style="margin-top:6px" id="pv_hsn_tbl">
            <thead>
              <tr><th>HSN/SAC</th><th class="tright">Taxable</th><th class="tright">CGST</th><th class="tright">SGST</th><th class="tright">IGST</th><th class="tright">Cess</th><th class="tright">Total</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="box">
          <div><strong>Declaration</strong></div>
          <div class="note" id="pv_terms">We declare that this invoice shows the actual price of the goods/services and that all particulars are true and correct.</div>
          <div class="note" id="pv_bank"></div>
          <div class="note">Reverse Charge: <span id="pv_rcm">No</span></div>
        </div>
        <div class="box">
          <div class="tright"><strong>For <span id="pv_sname2"></span></strong></div>
          <div class="tright note" style="margin-top:24px">Authorised Signatory</div>
          <div class="tright"><div class="signature" id="signBox">Signature</div></div>
        </div>
      </div>

      <div class="note" style="margin-top:8px">This is a computer-generated invoice. e-Invoice (IRN) not generated.</div>
    </div>
  </div>
</div>

<script>
/* ===== Utilities ===== */
const ru = n => (Math.round(n*100)/100).toFixed(2);
const byId = id => document.getElementById(id);

// Indian currency to words
function numberToWordsIndian(num){
  const a=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine","Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"];
  const b=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];
  function inWords(n){
    if(n<20) return a[n];
    if(n<100) return b[Math.floor(n/10)] + (n%10?" "+a[n%10]:"");
    if(n<1000) return a[Math.floor(n/100)]+" Hundred"+(n%100?" and "+inWords(n%100):"");
    if(n<100000) return inWords(Math.floor(n/1000))+" Thousand"+(n%1000?" "+inWords(n%1000):"");
    if(n<10000000) return inWords(Math.floor(n/100000))+" Lakh"+(n%100000?" "+inWords(n%100000):"");
    return inWords(Math.floor(n/10000000))+" Crore"+(n%10000000?" "+inWords(n%10000000):"");
  }
  const whole = Math.floor(num);
  const paise = Math.round((num - whole)*100);
  let words = (whole===0?"Zero":inWords(whole)) + " Rupees";
  if(paise>0) words += " and " + inWords(paise) + " Paise";
  return words + " Only";
}

// Simple state codes (few common prefilled for convenience)
const STATE_CODES = {
  "01":"Jammu & Kashmir","02":"Himachal Pradesh","03":"Punjab","04":"Chandigarh","05":"Uttarakhand","06":"Haryana",
  "07":"Delhi","08":"Rajasthan","09":"Uttar Pradesh","10":"Bihar","19":"West Bengal","20":"Jharkhand",
  "21":"Odisha","22":"Chhattisgarh","23":"Madhya Pradesh","24":"Gujarat","27":"Maharashtra","29":"Karnataka",
  "30":"Goa","32":"Kerala","33":"Tamil Nadu","36":"Telangana","37":"Andhra Pradesh"
};

function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }

/* ===== Items handling ===== */
const itemsBody = byId('itemsBody');

function addRow(data={}){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="tcenter idx"></td>
    <td><input class="cell desc" placeholder="Description" value="${data.desc||""}"></td>
    <td><input class="cell hsn" placeholder="HSN/SAC" value="${data.hsn||""}"></td>
    <td class="tcenter"><input type="number" step="0.001" class="cell qty" value="${data.qty||1}"></td>
    <td><input class="cell unit" placeholder="Nos/Kg/Hr" value="${data.unit||"Nos"}"></td>
    <td class="tright"><input type="number" step="0.01" class="cell rate" value="${data.rate||0}"></td>
    <td class="tright"><input type="number" step="0.01" class="cell disc" value="${data.disc||0}"></td>
    <td class="tcenter">
      <select class="cell gst">
        ${[0,5,12,18,28].map(v=>`<option ${(+data.gst===v)?"selected":""}>${v}</option>`).join('')}
      </select>
    </td>
    <td class="tcenter"><input type="number" step="0.01" class="cell cess" value="${data.cess||0}"></td>
    <td class="tright taxable">0.00</td>
    <td class="tright">
      <button class="ghost del">Delete</button>
    </td>`;
  itemsBody.appendChild(tr);
  renumber();
}

function renumber(){
  [...itemsBody.querySelectorAll('tr')].forEach((tr,i)=>{
    tr.querySelector('.idx').textContent = i+1;
  });
  calc();
}

function clearItems(){ itemsBody.innerHTML=''; renumber(); }

byId('addItem').onclick = ()=> addRow();
byId('clearItems').onclick = ()=> clearItems();
itemsBody.addEventListener('input', e=>{ if(e.target.classList.contains('cell')) calc(); });
itemsBody.addEventListener('click', e=>{
  if(e.target.classList.contains('del')){ e.target.closest('tr').remove(); renumber(); }
});

/* ===== Calculations ===== */
function getTaxMode(){
  const mode = byId('tax_mode').value;
  if(mode!=='auto') return mode;
  // Auto: interstate if supplier state code != POS code (or buyer's)
  const s = (byId('s_statecode').value||"").trim();
  const pos = (byId('pos_code').value||byId('b_statecode').value||"").trim();
  if(!s || !pos) return 'cgst_sgst';
  return (s===pos)? 'cgst_sgst' : 'igst';
}

function collectItems(){
  const rows = [...itemsBody.querySelectorAll('tr')];
  return rows.map(tr=>{
    const g = v=>tr.querySelector(v);
    const qty = parseFloat(g('.qty').value||0);
    const rate= parseFloat(g('.rate').value||0);
    const disc= parseFloat(g('.disc').value||0);
    const amt = qty*rate;
    const disAmt = amt*disc/100;
    const taxable = Math.max(0, amt - disAmt);
    tr.querySelector('.taxable').textContent = ru(taxable);
    return {
      desc:g('.desc').value.trim(),
      hsn:g('.hsn').value.trim(),
      unit:g('.unit').value.trim(),
      qty, rate, disc,
      gst: parseFloat(g('.gst').value||0),
      cess: parseFloat(g('.cess').value||0),
      taxable
    };
  }).filter(r=>r.desc || r.taxable>0);
}

function calc(){
  const items = collectItems();
  const addAmt = parseFloat(byId('add_amount').value||0);
  const addGST = parseFloat(byId('add_gst').value||0);
  const addDesc = byId('add_desc').value.trim();
  const addHSN = byId('add_hsn').value.trim();
  const postTax = parseFloat(byId('post_tax').value||0);

  const mode = getTaxMode();
  const zeroRated = (byId('tax_mode').value==='zero');

  let totalTaxable = 0, cgst=0, sgst=0, igst=0, cess=0;

  // HSN summary map
  const hsnMap = {}; // key => {taxable,cgst,sgst,igst,cess}
  function addHSN(hsnKey, t, cg, sg, ig, cs){
    const k = hsnKey||'-';
    if(!hsnMap[k]) hsnMap[k]={taxable:0,cgst:0,sgst:0,igst:0,cess:0};
    hsnMap[k].taxable+=t; hsnMap[k].cgst+=cg; hsnMap[k].sgst+=sg; hsnMap[k].igst+=ig; hsnMap[k].cess+=cs;
  }

  // line items
  items.forEach(it=>{
    totalTaxable += it.taxable;
    let lineCG=0,lineSG=0,lineIG=0;
    if(!zeroRated){
      if(mode==='igst'){ lineIG = it.taxable * it.gst/100; }
      else { lineCG = it.taxable * (it.gst/2)/100; lineSG = it.taxable * (it.gst/2)/100; }
    }
    const lineCess = it.taxable * (it.cess||0)/100;

    cgst+=lineCG; sgst+=lineSG; igst+=lineIG; cess+=lineCess;
    addHSN(it.hsn, it.taxable, lineCG, lineSG, lineIG, lineCess);
  });

  // Additional taxable charge (treated like separate item)
  let addCG=0, addSG=0, addIG=0, addCess=0;
  if(addAmt>0){
    totalTaxable += addAmt;
    if(!zeroRated){
      if(mode==='igst'){ addIG = addAmt*addGST/100; }
      else { addCG = addAmt*(addGST/2)/100; addSG = addAmt*(addGST/2)/100; }
    }
    cgst+=addCG; sgst+=addSG; igst+=addIG; // no cess for add line
    addHSN(addHSN||'Freight', addAmt, addCG, addSG, addIG, 0);
  }

  const taxTotal = cgst+sgst+igst+cess;
  let gross = totalTaxable + taxTotal + postTax;

  // Round off to nearest rupee
  const rounded = Math.round(gross);
  const roundOff = rounded - gross;
  const invoiceTotal = gross + roundOff;

  // Push to preview
  byId('pv_taxable').textContent = ru(totalTaxable);
  byId('pv_addtaxable').textContent = ru(addAmt||0);
  byId('pv_posttax').textContent = ru(postTax||0);
  byId('pv_cgst').textContent = ru(cgst);
  byId('pv_sgst').textContent = ru(sgst);
  byId('pv_igst').textContent = ru(igst);
  byId('pv_cess').textContent = ru(cess);
  byId('pv_roundoff').textContent = ru(roundOff);
  byId('pv_total').textContent = ru(invoiceTotal);
  byId('pv_words').textContent = numberToWordsIndian(invoiceTotal);

  // Items into preview
  const tb = byId('pv_items'); tb.innerHTML='';
  let idx=1;
  items.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="tcenter">${idx++}</td>
      <td>${escapeHtml(it.desc)}</td>
      <td>${escapeHtml(it.hsn||'')}</td>
      <td class="tcenter">${it.qty}</td>
      <td class="tcenter">${escapeHtml(it.unit||'')}</td>
      <td class="tright">${ru(it.rate)}</td>
      <td class="tright">${it.disc? (it.disc+'%'):'-'}</td>
      <td class="tcenter">${it.gst}%</td>
      <td class="tcenter">${it.cess||0}%</td>
      <td class="tright">${ru(it.taxable)}</td>
    `;
    tb.appendChild(tr);
  });
  if(addAmt>0){
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="tcenter">${idx++}</td>
      <td>${escapeHtml(addDesc||'Additional Charge')}</td>
      <td>${escapeHtml(addHSN||'')}</td>
      <td class="tcenter">1</td>
      <td class="tcenter">Job</td>
      <td class="tright">${ru(addAmt)}</td>
      <td class="tright">-</td>
      <td class="tcenter">${addGST}%</td>
      <td class="tcenter">0%</td>
      <td class="tright">${ru(addAmt)}</td>`;
    tb.appendChild(tr);
  }

  // HSN summary table
  const hsntb = byId('pv_hsn_tbl').querySelector('tbody');
  hsntb.innerHTML='';
  Object.keys(hsnMap).forEach(k=>{
    const r=hsnMap[k];
    const tot = r.taxable + r.cgst + r.sgst + r.igst + r.cess;
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(k)}</td>
      <td class="tright">${ru(r.taxable)}</td>
      <td class="tright">${ru(r.cgst)}</td>
      <td class="tright">${ru(r.sgst)}</td>
      <td class="tright">${ru(r.igst)}</td>
      <td class="tright">${ru(r.cess)}</td>
      <td class="tright">${ru(tot)}</td>`;
    hsntb.appendChild(tr);
  });

  return {invoiceTotal};
}

function escapeHtml(s){
  return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ===== Bind header/preview fields ===== */
function syncHeader(){
  byId('pv_invno').textContent = (byId('inv_prefix').value||'') + (byId('inv_number').value||'');
  byId('pv_invdate').textContent = byId('inv_date').value||'';
  byId('pv_due').textContent = byId('inv_due').value||'';

  byId('pv_sname').textContent = byId('s_name').value||'';
  byId('pv_sname2').textContent = byId('s_name').value||'';
  byId('pv_saddr').textContent = (byId('s_addr').value||'');
  byId('pv_sgstin').textContent = byId('s_gstin').value||'';
  byId('pv_sstate').textContent = byId('s_state').value||'';
  byId('pv_scode').textContent = byId('s_statecode').value||'';
  byId('pv_span').textContent = byId('s_pan').value||'';

  byId('pv_bname').textContent = byId('b_name').value||'';
  byId('pv_baddr').textContent = byId('b_addr').value||'';
  byId('pv_bgstin').textContent = byId('b_gstin').value||'';
  byId('pv_bstate').textContent = byId('b_state').value||'';
  byId('pv_bcode').textContent = byId('b_statecode').value||'';
  byId('pv_pos').textContent = byId('pos_state').value||byId('b_state').value||'';
  byId('pv_poscode').textContent = byId('pos_code').value||byId('b_statecode').value||'';
  byId('pv_ecom').textContent = byId('ecom').value||'-';

  byId('pv_terms').textContent = byId('terms').value||byId('pv_terms').textContent;
  byId('pv_bank').textContent = byId('s_bank').value? ("Bank/UPI: "+byId('s_bank').value):"";
  byId('pv_rcm').textContent = byId('reverse_charge').value||'No';
}

/* ===== Files: logo & signature ===== */
byId('s_logo').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{ const img=new Image(); img.src=reader.result; const lb=byId('logoBox'); lb.innerHTML=''; lb.appendChild(img); saveDraft(false); };
  reader.readAsDataURL(f);
});
byId('s_sign').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{ const img=new Image(); img.src=reader.result; img.style.maxHeight='60px'; const sb=byId('signBox'); sb.innerHTML=''; sb.appendChild(img); saveDraft(false); };
  reader.readAsDataURL(f);
});

/* ===== Events ===== */
document.querySelectorAll('input,textarea,select').forEach(el=>{
  el.addEventListener('input', ()=>{ syncHeader(); calc(); saveDraft(false); });
});
byId('recalc').onclick = ()=>{ syncHeader(); calc(); };
byId('printBtn').onclick = ()=>{ syncHeader(); calc(); window.print(); };
byId('newNumber').onclick = ()=>{
  const n = (parseInt(byId('inv_number').value||'0',10)||0)+1;
  byId('inv_number').value = String(n).padStart(4,'0');
  syncHeader(); saveDraft(false);
};

/* ===== Save / Load ===== */
function getFormData(){
  const fields=[...document.querySelectorAll('input,textarea,select')].filter(x=>x.type!=='file');
  const data={};
  fields.forEach(f=>data[f.id]=f.value);
  // items
  data.items = collectItems().map(it=>({desc:it.desc,hsn:it.hsn,unit:it.unit,qty:it.qty,rate:it.rate,disc:it.disc,gst:it.gst,cess:it.cess}));
  // images
  const logoImg = byId('logoBox').querySelector('img');
  const signImg = byId('signBox').querySelector('img');
  data._logo = logoImg? logoImg.src : null;
  data._sign = signImg? signImg.src : null;
  return data;
}
function setFormData(data){
  if(!data) return;
  Object.keys(data).forEach(k=>{
    const el = byId(k); if(el && el.type!=='file' && !Array.isArray(data[k])) el.value = data[k];
  });
  clearItems();
  (data.items||[]).forEach(r=>addRow(r));
  if(data.items?.length===0) addRow();
  if(data._logo){ const img=new Image(); img.src=data._logo; const lb=byId('logoBox'); lb.innerHTML=''; lb.appendChild(img); }
  if(data._sign){ const img=new Image(); img.src=data._sign; img.style.maxHeight='60px'; const sb=byId('signBox'); sb.innerHTML=''; sb.appendChild(img); }
  syncHeader(); calc();
}
function saveDraft(show=true){
  const data = getFormData();
  localStorage.setItem('gst_invoice_draft_v1', JSON.stringify(data));
  if(show) alert('Saved locally.');
}
function loadDraft(){
  const s = localStorage.getItem('gst_invoice_draft_v1');
  if(!s) return alert('No saved draft found.');
  setFormData(JSON.parse(s));
}
byId('saveDraft').onclick = ()=> saveDraft(true);
byId('loadDraft').onclick = ()=> loadDraft();
byId('exportJson').onclick = ()=>{
  const blob = new Blob([JSON.stringify(getFormData(),null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='invoice.json'; a.click();
};
byId('importJson').onclick = ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = ()=>{
    const f=inp.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=> setFormData(JSON.parse(r.result)); r.readAsText(f);
  };
  inp.click();
};

/* ===== Defaults ===== */
function initDefaults(){
  byId('inv_date').value = todayISO();
  const due = new Date(); due.setDate(due.getDate()+7);
  byId('inv_due').value = due.toISOString().slice(0,10);
  if(!byId('s_statecode').value) byId('s_statecode').value='27';
  if(!byId('s_state').value) byId('s_state').value=STATE_CODES['27']||'Maharashtra';
  if(!byId('pos_code').value) byId('pos_code').value='27';
  if(!byId('pos_state').value) byId('pos_state').value=STATE_CODES['27']||'Maharashtra';
  if(itemsBody.children.length===0){ addRow({gst:18}); }
  syncHeader(); calc();
}
initDefaults();

</script>
</body>
</html>
